# .github/workflows/docker-build-publish.yml
name: ğŸ³ Build & Publish gpt-proxy Docker Image

on:
  push:
    branches:
      - main # å½“ä»£ç æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
    tags:
      - 'v*.*.*' # å½“åˆ›å»º vX.Y.Z æ ¼å¼çš„ Git Tag æ—¶è§¦å‘
  pull_request:
    branches:
      - main # å¯¹ main åˆ†æ”¯çš„ PR ä¹Ÿè¿›è¡Œæ„å»ºï¼Œä½†ä¸å‘å¸ƒ
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘æ­¤ workflow

env:
  # æ›¿æ¢ä¸ºä½ çš„ Docker Hub ç”¨æˆ·åå’Œé•œåƒå
  # ä¾‹å¦‚ï¼šyour-docker-username/gpt-proxy
  DOCKER_IMAGE_NAME: nalvix/gpt-proxy 

jobs:
  build-and-publish:
    runs-on: ubuntu-latest # åœ¨ Ubuntu è™šæ‹Ÿæœºä¸Šè¿è¡Œ

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4 # æ‹‰å–ä»“åº“ä»£ç 

      - name: âš™ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3 # è®¾ç½® Docker Buildxï¼Œæ”¯æŒå¤šå¹³å°å’Œç¼“å­˜

      - name: ğŸ”‘ Login to Docker Hub
        # åªæœ‰åœ¨é Pull Request äº‹ä»¶æ—¶æ‰ç™»å½•å’Œå‘å¸ƒ
        if: github.event_name != 'pull_request' 
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ·ï¸ Extract Docker metadata (tags, labels)
        id: meta # ä¸ºæ­¤æ­¥éª¤åˆ†é…ä¸€ä¸ª IDï¼Œä»¥ä¾¿å…¶ä»–æ­¥éª¤å¼•ç”¨å…¶è¾“å‡º
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE_NAME }} # ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„é•œåƒå
          tags: | # å®šä¹‰é•œåƒæ ‡ç­¾çš„ç”Ÿæˆè§„åˆ™
            type=schedule
            type=ref,event=branch # ä¾‹å¦‚ï¼šmain -> latest (å¦‚æœé»˜è®¤åˆ†æ”¯) æˆ– main
            type=ref,event=pr # ä¾‹å¦‚ï¼špr-123
            type=semver,pattern={{version}} # ä¾‹å¦‚ï¼šv1.0.0 -> 1.0.0
            type=semver,pattern={{major}}.{{minor}} # ä¾‹å¦‚ï¼šv1.0.0 -> 1.0
            type=semver,pattern={{major}} # ä¾‹å¦‚ï¼šv1.0.0 -> 1
            type=sha,format=long # ä¾‹å¦‚ï¼šabcdef123456
            # åªæœ‰åœ¨æ¨é€åˆ°é»˜è®¤åˆ†æ”¯ (main) æ—¶æ‰æ‰“ latest æ ‡ç­¾
            type=raw,value=latest,enable=${{ github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }} 

      - name: ğŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: . # Dockerfile çš„ä¸Šä¸‹æ–‡è·¯å¾„ï¼Œé»˜è®¤ä¸ºå½“å‰ä»“åº“æ ¹ç›®å½•
          file: ./Dockerfile # Dockerfile çš„è·¯å¾„ï¼Œé»˜è®¤ä¸º Dockerfile
          # åªæœ‰åœ¨é Pull Request äº‹ä»¶æ—¶æ‰è¿›è¡Œ push
          push: ${{ github.event_name != 'pull_request' }} 
          tags: ${{ steps.meta.outputs.tags }} # ä½¿ç”¨ metadata-action ç”Ÿæˆçš„æ ‡ç­¾
          labels: ${{ steps.meta.outputs.labels }} # ä½¿ç”¨ metadata-action ç”Ÿæˆçš„æ ‡ç­¾
          cache-from: type=gha # å¯ç”¨ GitHub Actions ç¼“å­˜ï¼ŒåŠ é€Ÿåç»­æ„å»º
          cache-to: type=gha,mode=max # å°†ç¼“å­˜å†™å…¥ GitHub Actions ç¼“å­˜
